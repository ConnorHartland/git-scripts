image: node:22

definitions:
  steps:
    - step: &build-extension
        name: Build Extension
        caches:
          - node
        script:
          - npm install
          - npm run build
        artifacts:
          - dist/**
    
    - step: &build-and-package
        name: Build and Package Extension
        script:
          # Files should already be built and packaged from release.js
          - echo "Using pre-built artifacts from release step"
        artifacts:
          - complaint.crx
          - update.xml
    
    - step: &deploy-to-s3
        name: Deploy to S3
        script:
          # Install AWS CLI
          - apt-get update && apt-get install -y awscli
          
          # Upload CRX file
          - aws s3 cp complaint.crx s3://${S3_BUCKET}/${S3_PATH}/complaint.crx --acl public-read
          
          # Upload update manifest
          - aws s3 cp update.xml s3://${S3_BUCKET}/${S3_PATH}/update.xml --acl public-read
          
          # Output the URLs
          - echo "Extension deployed to https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/complaint.crx"
          - echo "Update manifest at https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/update.xml"

pipelines:
  branches:
    main:
      - step: *build-extension
      - step:
          name: Create Release Tag
          script:
            # Create git tag if version changed
            - node scripts/tag-on-version-change.js

  pull-requests:
    '**':
      - step:
          name: Build and Test PR
          caches:
            - node
          script:
            - npm install
            - npm run build

  custom:
    create-release:
      - variables:
          - name: TYPE
            allowed-values:
              - Major
              - Minor
              - Patch
      - stage:
          name: Prepare Release
          steps:
            - step:
                name: Create Release and Build
                caches:
                  - node
                script:
                  # Run the release process (version bump, branch creation, build)
                  - node scripts/release.js
                artifacts:
                  - dist/**
                  - version.env
      - stage:
          name: Deploy to Dev
          deployment: dev
          steps:
            - step:
                name: Package and Deploy to Dev
                script:
                  # Install crx3 for packaging
                  - npm install -g crx3
                  
                  # Package extension (needs EXTENSION_PRIVATE_KEY from deployment)
                  - node scripts/package-extension.js
                  
                  # Generate update manifest (needs CRX_BASE_URL, EXTENSION_ID from deployment)
                  - source version.env
                  - node scripts/generate-update-xml.js
                  
                  # Install AWS CLI and deploy
                  - apt-get update && apt-get install -y awscli
                  
                  # Set S3 path for dev
                  - export S3_PATH="dev"
                  
                  # Upload CRX file
                  - aws s3 cp complaint.crx s3://${S3_BUCKET}/${S3_PATH}/complaint.crx --acl public-read
                  
                  # Upload update manifest
                  - aws s3 cp update.xml s3://${S3_BUCKET}/${S3_PATH}/update.xml --acl public-read
                  
                  # Output the URLs
                  - echo "Extension deployed to https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/complaint.crx"
                  - echo "Update manifest at https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/update.xml"
                artifacts:
                  - complaint.crx
                  - update.xml
      - stage:
          name: Deploy to Prod
          deployment: prod
          trigger: manual
          steps:
            - step:
                name: Deploy to Prod Environment
                script:
                  # Install AWS CLI
                  - apt-get update && apt-get install -y awscli
                  
                  # Set S3 path for prod
                  - export S3_PATH="prod"
                  
                  # Upload CRX file (already packaged in dev stage)
                  - aws s3 cp complaint.crx s3://${S3_BUCKET}/${S3_PATH}/complaint.crx --acl public-read
                  
                  # Upload update manifest (already generated in dev stage)
                  - aws s3 cp update.xml s3://${S3_BUCKET}/${S3_PATH}/update.xml --acl public-read
                  
                  # Output the URLs
                  - echo "Extension deployed to https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/complaint.crx"
                  - echo "Update manifest at https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/update.xml"
      - stage:
          name: Create Pull Request
          steps:
            - step:
                name: Create PR back to main
                script:
                  # Source the version and create PR
                  - source version.env
                  - |
                    curl -X POST "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_WORKSPACE}/${BITBUCKET_REPO_SLUG}/pullrequests" \
                      -H "Authorization: Bearer ${BITBUCKET_ACCESS_TOKEN}" \
                      -H "Content-Type: application/json" \
                      -d "{
                        \"title\": \"Release v${VERSION}\",
                        \"description\": \"Automated release for version ${VERSION}\",
                        \"source\": {\"branch\": {\"name\": \"release/v${VERSION}\"}},
                        \"destination\": {\"branch\": {\"name\": \"main\"}},
                        \"close_source_branch\": false
                      }"
