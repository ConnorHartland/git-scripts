image: node:22

definitions:
  steps:
    - step: &build-extension
        name: Build Extension
        caches:
          - node
        script:
          - npm install
          - npm run build
        artifacts:
          - dist/**
    
    - step: &build-and-package
        name: Build and Package Extension
        script:
          # Files should already be built and packaged from release.js
          - echo "Using pre-built artifacts from release step"
        artifacts:
          - complaint.crx
          - update.xml
    
    - step: &deploy-to-s3
        name: Deploy to S3
        image: amazon/aws-cli:latest
        script:
          # Upload CRX file
          - aws s3 cp complaint.crx s3://${S3_BUCKET}/${S3_PATH}/complaint.crx --acl public-read
          
          # Upload update manifest
          - aws s3 cp update.xml s3://${S3_BUCKET}/${S3_PATH}/update.xml --acl public-read
          
          # Output the URLs
          - echo "Extension deployed to https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/complaint.crx"
          - echo "Update manifest at https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/update.xml"

pipelines:
  branches:
    main:
      - step: *build-extension

    release/*:
      - step: *build-extension
      - step:
          name: Package Extension
          script:
            # Install crx3 for packaging
            - npm install -g crx3
            # Package extension (needs EXTENSION_PRIVATE_KEY)
            - node scripts/package-extension.js
            # Generate update manifest (needs CRX_BASE_URL, EXTENSION_ID)
            - node scripts/generate-update-xml.js
          artifacts:
            - complaint.crx
            - update.xml
      - step:
          name: Deploy to Dev
          image: amazon/aws-cli:latest
          deployment: dev
          script:
            # Set S3 path for dev
            - export S3_PATH="dev"
            # Upload CRX file
            - aws s3 cp complaint.crx s3://${S3_BUCKET}/${S3_PATH}/complaint.crx --acl public-read
            # Upload update manifest
            - aws s3 cp update.xml s3://${S3_BUCKET}/${S3_PATH}/update.xml --acl public-read
            # Output the URLs
            - echo "Extension deployed to https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/complaint.crx"
            - echo "Update manifest at https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/update.xml"
      - step:
          name: Deploy to Prod
          image: amazon/aws-cli:latest
          deployment: prod
          trigger: manual
          script:
            # Set S3 path for prod
            - export S3_PATH="prod"
            # Upload CRX file
            - aws s3 cp complaint.crx s3://${S3_BUCKET}/${S3_PATH}/complaint.crx --acl public-read
            # Upload update manifest
            - aws s3 cp update.xml s3://${S3_BUCKET}/${S3_PATH}/update.xml --acl public-read
            # Output the URLs
            - echo "Extension deployed to https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/complaint.crx"
            - echo "Update manifest at https://${S3_BUCKET}.s3.amazonaws.com/${S3_PATH}/update.xml"
      - step:
          name: Tag Release
          script:
            # Extract version from package.json
            - export VERSION=$(node -e "console.log(require('./package.json').version)")
            - export TAG_NAME="v${VERSION}"
            # Create annotated tag
            - git tag -a "${TAG_NAME}" -m "Release version ${VERSION}"
            # Push tag to remote
            - git push origin "${TAG_NAME}"
            - echo "✓ Tagged release as ${TAG_NAME}"
      - step:
          name: Merge Release to Main
          script:
            # Fetch latest from remote
            - git fetch origin main
            # Checkout main
            - git checkout main
            # Merge release branch
            - git merge --no-ff $BITBUCKET_BRANCH -m "Merge release $BITBUCKET_BRANCH into main"
            # Push back to main
            - git push origin main
            # Delete release branch
            - git push origin --delete $BITBUCKET_BRANCH
            - echo "✓ Merged $BITBUCKET_BRANCH into main and deleted branch"

  pull-requests:
    '**':
      - step:
          name: Build and Test PR
          caches:
            - node
          script:
            - npm install
            - npm run build

  custom:
    create-release:
      - variables:
          - name: TYPE
            allowed-values:
              - Major
              - Minor
              - Patch
      - step:
          name: Create Release Branch
          caches:
            - node
          script:
            # Run the release process (version bump, branch creation, push)
            - node scripts/release.js
